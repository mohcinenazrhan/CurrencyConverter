"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function t(t,n,r){var o,c=new Promise(function(c,i){e(o=t[n].apply(t,r)).then(c,i)});return c.request=o,c}function n(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function r(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return t(this[n],o,arguments)})})}function o(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function c(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return e=this[n],(r=t(e,o,arguments)).then(function(e){if(e)return new u(e,r.request)});var e,r})})}function i(e){this._index=e}function u(e,t){this._cursor=e,this._request=t}function s(e){this._store=e}function a(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function l(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new a(n)}function d(e){this._db=e}n(i,"_index",["name","keyPath","multiEntry","unique"]),r(i,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),c(i,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(u,"_cursor",["direction","key","primaryKey","value"]),r(u,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(u.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new u(e,n._request)})})})}),s.prototype.createIndex=function(){return new i(this._store.createIndex.apply(this._store,arguments))},s.prototype.index=function(){return new i(this._store.index.apply(this._store,arguments))},n(s,"_store",["name","keyPath","indexNames","autoIncrement"]),r(s,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),c(s,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(s,"_store",IDBObjectStore,["deleteIndex"]),a.prototype.objectStore=function(){return new s(this._tx.objectStore.apply(this._tx,arguments))},n(a,"_tx",["objectStoreNames","mode"]),o(a,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new s(this._db.createObjectStore.apply(this._db,arguments))},n(l,"_db",["name","version","objectStoreNames"]),o(l,"_db",IDBDatabase,["deleteObjectStore","close"]),d.prototype.transaction=function(){return new a(this._db.transaction.apply(this._db,arguments))},n(d,"_db",["name","version","objectStoreNames"]),o(d,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[s,i].forEach(function(t){e in t.prototype&&(t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],o=this._store||this._index,c=o[e].apply(o,n.slice(0,-1));c.onsuccess=function(){r(c.result)}})})}),[i,s].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():o(r)):o(r)})})})});var f={open:function(e,n,r){var o=t(indexedDB,"open",[e,n]),c=o.request;return c&&(c.onupgradeneeded=function(e){r&&r(new l(c.result,e.oldVersion,c.transaction))}),o.then(function(e){return new d(e)})},delete:function(e){return t(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?(module.exports=f,module.exports.default=module.exports):self.idb=f}();var CurrencyConverter=function(){function e(t){_classCallCheck(this,e),this._container=t.container,this._fromCurrency=t.fromCurrency,this._toCurrency=t.toCurrency,this._isLoading=t.isLoading,this._spinner=t.spinner,this._fromSymbol=t.fromSymbol,this._toSymbol=t.toSymbol,this._convertBtn=t.convert,this._fromAmount=t.fromAmount,this._toAmount=t.toAmount,this._message=t.message,this._refreshing=!1,this._dbPromise=this.openIdbStore(),this.serviceWorkerRegistration()}return _createClass(e,[{key:"openIdbStore",value:function(){return idb.open("CurrencyConverter-store",1,function(e){e.createObjectStore("selectedCurrency"),e.createObjectStore("currencyList",{keyPath:"currencyId"})})}},{key:"serviceWorkerRegistration",value:function(){var e=this;if(navigator.serviceWorker){var t=this;navigator.serviceWorker.addEventListener("controllerchange",function(){e._refreshing||(window.location.reload(),e._refreshing=!0)}),navigator.serviceWorker.register("./service-worker.js").then(function(e){console.log("Service Worker Registered"),navigator.serviceWorker.controller&&(e.waiting?t._updateReady():e.installing?indexController.trackingprogressInstalled(e.installing):e.addEventListener("updatefound",function(){t.trackingprogressInstalled(e.installing)}))}).catch(function(e){return console.log("Service worker not registered: ",e)})}}},{key:"updateReady",value:function(e){confirm("New version available online. Do you want to update? ")&&e.postMessage({action:"skipWaiting"})}},{key:"trackingprogressInstalled",value:function(e){var t=this;e.addEventListener("statechange",function(){"installed"==e.state&&t.updateReady(e)})}},{key:"getAllCurrencies",value:function(){var e=this,t="https://free.currencyconverterapi.com/api/v5/countries";return this.getAllCurrenciesCache(t).then(function(n){return!1===n?e.getAllCurrenciesNetwork(t):n}).then(function(e){return e.json()}).then(function(e){var t=[];for(var n in e.results)t.push(e.results[n]);return t}).then(function(e){var t="";return e.sort(function(e,t){return e.currencyName>t.currencyName?1:-1}).filter(function(e){var n=t;if(t=e.currencyName,e.currencyName!=n)return e})})}},{key:"getAllCurrenciesCache",value:function(e){return"caches"in window&&caches.match(e).then(function(e){return e||!1}).catch(function(){return console.log("error cache"),!1})}},{key:"getAllCurrenciesNetwork",value:function(e){return fetch(e).then(function(e){return e}).catch(function(e){return console.log("error network",e)})}},{key:"getCurrencyListDB",value:function(){return this._dbPromise.then(function(e){return!!e&&e.transaction("currencyList").objectStore("currencyList").getAll().then(function(e){return 0!==e.length&&e}).catch(function(){return!1})}).catch(function(e){return console.log("db error: ",e),!1})}},{key:"setCurrencyListDB",value:function(e){var t=this;e?e.then(function(e){t._dbPromise.then(function(t){if(t){var n=t.transaction("currencyList","readwrite").objectStore("currencyList"),r=!0,o=!1,c=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done);r=!0){var s=i.value;n.put(s)}}catch(e){o=!0,c=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw c}}}}).catch(function(e){return console.log("idb error: ",e)})}):console.log("Data is undefined to be stored")}},{key:"setSymbolCurrency",value:function(){var e=this,t=this._fromCurrency,n=this._toCurrency;t=t.options[t.selectedIndex].value,n=n.options[n.selectedIndex].value,this._dbPromise.then(function(r){if(r){var o=r.transaction("currencyList").objectStore("currencyList");o.get(t).then(function(t){e._fromSymbol.innerHTML=t.currencySymbol}),o.get(n).then(function(t){e._toSymbol.innerHTML=t.currencySymbol})}}).catch(function(e){console.log("idb error ",e)})}},{key:"fillListsCurrencies",value:function(){var e=this;return this.getCurrencyListDB().then(function(t){if(t)return t;var n=e.getAllCurrencies();return e.setCurrencyListDB(n),n}).then(function(t){var n="";t.forEach(function(e){n+='<option value="'+e.currencyId+'">'+e.currencyName+" | "+e.currencyId+" ("+e.currencySymbol+")</option>"}),e._fromCurrency.innerHTML=n,e._toCurrency.innerHTML=n}).then(function(){return e._dbPromise.then(function(e){return!!e&&e.transaction("selectedCurrency").objectStore("selectedCurrency").get("lastSelect")})}).then(function(t){if(t)return e._fromCurrency.value=t.from,e._toCurrency.value=t.to,e.setSymbolCurrency(),void e.convert();var n=e._fromCurrency,r=e._toCurrency;n=n.options[n.selectedIndex].value,r=r.options[r.selectedIndex].value,e.setSymbolCurrency(),e.convert()}).then(function(){e._isLoading&&(e._spinner.setAttribute("hidden",!0),e._container.removeAttribute("hidden"),e._isLoading=!1)})}},{key:"saveSelectedCurrency",value:function(e,t){this._dbPromise.then(function(n){if(n){var r=n.transaction("selectedCurrency","readwrite");return r.objectStore("selectedCurrency").put({from:e,to:t},"lastSelect"),r.complete}})}},{key:"setConvertedValue",value:function(e,t){this._toAmount.value=""!==e&&void 0!==e?(e*t).toFixed(6):"",this._convertBtn.innerHTML="Convert"}},{key:"setSelectedCurrenciesdb",value:function(e){return this._dbPromise.then(function(t){if(!t)return!1;var n=t.transaction("selectedCurrency","readwrite");for(var r in e)n.objectStore("selectedCurrency").put({val:e[r].val},r)}).catch(function(e){console.log("idb error ",e)})}},{key:"convert",value:function(){var e=this;this._convertBtn.innerHTML="Converting...";var t=this._fromCurrency,n=this._toCurrency;t=t.options[t.selectedIndex].value,n=n.options[n.selectedIndex].value,this.saveSelectedCurrency(t,n);var r=this._fromAmount.value,o=t+"_"+n,c=n+"_"+t;if(o!==c){var i="https://free.currencyconverterapi.com/api/v5/convert?q="+o+","+c,u=!0;this._dbPromise.then(function(e){return!!e&&e.transaction("selectedCurrency").objectStore("selectedCurrency").get(o)}).then(function(t){void 0!==t?(console.log("Get value currency from idb"),e.setConvertedValue(t.val,r)):u=!1}).then(function(){u?e._message.innerHTML="Value from cache. Go online and update.":u||(e._message.innerHTML="Value not available in cache. Go online and refresh.")}).catch(function(e){console.log(e),u=null}),fetch(i).then(function(e){return e.json()}).then(function(t){return e.setSelectedCurrenciesdb(t.results),t.results[o]}).then(function(t){console.log("Get & update idb value currency from network"),e._message.innerHTML="",e.setConvertedValue(t.val,r)}).catch(function(t){console.log(t),e._convertBtn.innerHTML="Convert",e._message.innerHTML="Go online and refresh."})}else this.setConvertedValue(1,r)}},{key:"switchCurrency",value:function(){var e=this._fromCurrency,t=this._toCurrency,n=e.options[e.selectedIndex].value,r=t.options[t.selectedIndex].value;e.value=r,t.value=n,this.setSymbolCurrency(),this.convert()}},{key:"changeCurrency",value:function(){var e=this,t=this._fromCurrency,n=this._toCurrency,r=t.options[t.selectedIndex].value,o=n.options[n.selectedIndex].value;this.setSymbolCurrency();var c=this._fromAmount.value,i=r+"_"+o;i!==o+"_"+r?this._dbPromise.then(function(e){return!!e&&e.transaction("selectedCurrency").objectStore("selectedCurrency").get(i)}).then(function(t){var n=t?t.val:"";e.setConvertedValue(n,c),""!=n&&(e._convertBtn.innerHTML="Update")}).catch(function(e){console.log(e)}):this.setConvertedValue(1,c)}}]),e}();!function(){var e={isLoading:!0,allCurrencies:[],fromCurrency:document.getElementById("fromCurrency"),toCurrency:document.getElementById("toCurrency"),fromSymbol:document.getElementById("fromSymbol"),toSymbol:document.getElementById("toSymbol"),fromAmount:document.getElementById("fromAmount"),toAmount:document.getElementById("toAmount"),convert:document.getElementById("convert"),switchCurrency:document.getElementById("switchCurrency"),message:document.getElementById("message"),spinner:document.querySelector(".loader"),container:document.querySelector(".main")},t=new CurrencyConverter(e);t.fillListsCurrencies(),e.convert.addEventListener("click",t.convert.bind(t)),e.switchCurrency.addEventListener("click",t.switchCurrency.bind(t)),e.fromCurrency.addEventListener("change",t.changeCurrency.bind(t)),e.toCurrency.addEventListener("change",t.changeCurrency.bind(t))}();